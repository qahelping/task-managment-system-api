"""
–ü–û–î–†–û–ë–ù–´–ô –°–ö–†–ò–ü–¢ –° –û–ë–™–Ø–°–ù–ï–ù–ò–ï–ú –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–î

–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
1. –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ë–î
2. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
3. –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
4. –ë–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –ë–î
"""
import sys
sys.path.insert(0, '.')

from app.database import SessionLocal, init_db, engine
from app.core.config import settings
from app.models.user import User
from app.models.board import Board
from app.models.task import Task
from app.core.security import get_password_hash


print("=" * 70)
print("–ü–û–î–†–û–ë–ù–û–ï –û–ë–™–Ø–°–ù–ï–ù–ò–ï –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –ë–î")
print("=" * 70)

# ============================================
# –®–ê–ì 1: –û–¢–ö–£–î–ê –ë–ï–†–Å–¢–°–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–î
# ============================================
print("\n1. –û–¢–ö–£–î–ê –ë–ï–†–Å–¢–°–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ë–î")
print("   " + "-" * 60)

print(f"\n   üìç –§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: app/core/config.py")
print(f"   üìç –ö–ª–∞—Å—Å: Settings")
print(f"   üìç –ü–∞—Ä–∞–º–µ—Ç—Ä: DATABASE_URL")

print(f"\n   –¢–µ–∫—É—â–∏–π URL –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:")
print(f"   {settings.DATABASE_URL}")

print(f"\n   –û—Ç–∫—É–¥–∞ –±–µ—Ä—ë—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ:")
print(f"   1. –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 'sqlite:///./app.db'")
print(f"   2. –ú–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ —á–µ—Ä–µ–∑ .env —Ñ–∞–π–ª")
print(f"   3. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: .env > –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")

print(f"\n   –§–æ—Ä–º–∞—Ç URL:")
print(f"   - sqlite:/// - –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è SQLite")
print(f"   - ./app.db - –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É –ë–î (–≤ —Ç–µ–∫—É—â–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏)")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ .env —Ñ–∞–π–ª
import os
if os.path.exists('.env'):
    print(f"\n   ‚úì –ù–∞–π–¥–µ–Ω —Ñ–∞–π–ª .env - –∑–Ω–∞—á–µ–Ω–∏—è –º–æ–≥—É—Ç –±—ã—Ç—å –ø–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã")
else:
    print(f"\n   ‚ö† –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é")

# ============================================
# –®–ê–ì 2: –°–û–ó–î–ê–ù–ò–ï –î–í–ò–ñ–ö–ê (ENGINE)
# ============================================
print("\n" + "=" * 70)
print("2. –°–û–ó–î–ê–ù–ò–ï –î–í–ò–ñ–ö–ê (ENGINE)")
print("   " + "-" * 60)

print(f"\n   üìç –§–∞–π–ª: app/database.py")
print(f"   üìç –ö–æ–¥: engine = create_engine(settings.DATABASE_URL)")

print(f"\n   –ß—Ç–æ —Ç–∞–∫–æ–µ engine?")
print(f"   - –≠—Ç–æ –æ–±—ä–µ–∫—Ç SQLAlchemy –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î")
print(f"   - –•—Ä–∞–Ω–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏")
print(f"   - –£–ø—Ä–∞–≤–ª—è–µ—Ç –ø—É–ª–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π")
print(f"   - –°–æ–∑–¥–∞—ë—Ç—Å—è –û–î–ò–ù –†–ê–ó –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è")

print(f"\n   –¢–µ–∫—É—â–∏–π engine:")
print(f"   {engine}")

print(f"\n   URL –¥–≤–∏–∂–∫–∞:")
print(f"   {engine.url}")

# ============================================
# –®–ê–ì 3: –°–û–ó–î–ê–ù–ò–ï –§–ê–ë–†–ò–ö–ò –°–ï–°–°–ò–ô (SESSIONLOCAL)
# ============================================
print("\n" + "=" * 70)
print("3. –°–û–ó–î–ê–ù–ò–ï –§–ê–ë–†–ò–ö–ò –°–ï–°–°–ò–ô (SESSIONLOCAL)")
print("   " + "-" * 60)

print(f"\n   üìç –§–∞–π–ª: app/database.py")
print(f"   üìç –ö–æ–¥: SessionLocal = sessionmaker(bind=engine)")

print(f"\n   –ß—Ç–æ —Ç–∞–∫–æ–µ SessionLocal?")
print(f"   - –≠—Ç–æ –§–ê–ë–†–ò–ö–ê –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π")
print(f"   - –≠—Ç–æ –ù–ï —Å–µ—Å—Å–∏—è, –∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π")
print(f"   - –ö–∞–∂–¥—ã–π –≤—ã–∑–æ–≤ SessionLocal() —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤—É—é —Å–µ—Å—Å–∏—é")

print(f"\n   –ü–∞—Ä–∞–º–µ—Ç—Ä—ã sessionmaker:")
print(f"   - autocommit=False - –Ω–µ –∫–æ–º–º–∏—Ç–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
print(f"   - autoflush=False - –Ω–µ —Å–±—Ä–∞—Å—ã–≤–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏")
print(f"   - bind=engine - –ø—Ä–∏–≤—è–∑–∫–∞ –∫ –¥–≤–∏–∂–∫—É")

print(f"\n   –¢–µ–∫—É—â–∏–π SessionLocal:")
print(f"   {SessionLocal}")

# ============================================
# –®–ê–ì 4: –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–î (INIT_DB)
# ============================================
print("\n" + "=" * 70)
print("4. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–î (init_db)")
print("   " + "-" * 60)

print(f"\n   üìç –§–∞–π–ª: app/database.py")
print(f"   üìç –§—É–Ω–∫—Ü–∏—è: init_db()")

print(f"\n   –ß—Ç–æ –¥–µ–ª–∞–µ—Ç init_db()?")
print(f"   1. –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –º–æ–¥–µ–ª–∏ (User, Board, Task, ...)")
print(f"   2. –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –∏—Ö –≤ Base.metadata")
print(f"   3. –°–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –≤ –ë–î —á–µ—Ä–µ–∑ Base.metadata.create_all()")

print(f"\n   –í–∞–∂–Ω–æ:")
print(f"   - –°–æ–∑–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã")
print(f"   - –ù–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ")
print(f"   - –ú–æ–∂–Ω–æ –≤—ã–∑—ã–≤–∞—Ç—å –º–Ω–æ–≥–æ–∫—Ä–∞—Ç–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ")

print(f"\n   –í—ã–∑—ã–≤–∞–µ–º init_db()...")
init_db()
print(f"   ‚úì –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞")

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∫–∏–µ —Ç–∞–±–ª–∏—Ü—ã —Å–æ–∑–¥–∞–Ω—ã
from sqlalchemy import inspect
inspector = inspect(engine)
tables = inspector.get_table_names()
print(f"\n   –°–æ–∑–¥–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã: {tables}")

# ============================================
# –®–ê–ì 5: –°–û–ó–î–ê–ù–ò–ï –°–ï–°–°–ò–ò
# ============================================
print("\n" + "=" * 70)
print("5. –°–û–ó–î–ê–ù–ò–ï –°–ï–°–°–ò–ò")
print("   " + "-" * 60)

print(f"\n   –°–æ–∑–¥–∞—ë–º —Å–µ—Å—Å–∏—é —á–µ—Ä–µ–∑ SessionLocal()...")
db = SessionLocal()
print(f"   ‚úì –°–µ—Å—Å–∏—è —Å–æ–∑–¥–∞–Ω–∞: {db}")

print(f"\n   –ß—Ç–æ —Ç–∞–∫–æ–µ —Å–µ—Å—Å–∏—è?")
print(f"   - –≠—Ç–æ –µ–¥–∏–Ω–∏—Ü–∞ —Ä–∞–±–æ—Ç—ã —Å –ë–î")
print(f"   - –ß–µ—Ä–µ–∑ –Ω–µ—ë –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏")
print(f"   - –ù—É–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è")

# ============================================
# –®–ê–ì 6: –†–ê–ë–û–¢–ê –° –ë–î
# ============================================
print("\n" + "=" * 70)
print("6. –†–ê–ë–û–¢–ê –° –ë–î")
print("   " + "-" * 60)

try:
    # –°–û–ó–î–ê–ù–ò–ï
    print(f"\n   –°–æ–∑–¥–∞—ë–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
    user = User(
        username="demo_user",
        email="demo@example.com",
        password_hash=get_password_hash("password123"),
        role="user"
    )
    db.add(user)           # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–µ—Å—Å–∏—é
    db.commit()            # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
    db.refresh(user)       # –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ –ë–î
    print(f"   ‚úì –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: {user.username} (ID: {user.id})")
    
    # –ü–û–ò–°–ö
    print(f"\n   –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...")
    found = db.query(User).filter(User.id == user.id).first()
    print(f"   ‚úì –ù–∞–π–¥–µ–Ω: {found.username}")
    
    # –°–¢–ê–¢–ò–°–¢–ò–ö–ê
    print(f"\n   –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
    users_count = db.query(User).count()
    print(f"   –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ë–î: {users_count}")
    
except Exception as e:
    print(f"\n   ‚ùå –û—à–∏–±–∫–∞: {e}")
    db.rollback()
    raise
    
finally:
    # ============================================
    # –®–ê–ì 7: –ó–ê–ö–†–´–¢–ò–ï –°–ï–°–°–ò–ò
    # ============================================
    print("\n" + "=" * 70)
    print("7. –ó–ê–ö–†–´–¢–ò–ï –°–ï–°–°–ò–ò")
    print("   " + "-" * 60)
    
    print(f"\n   –í–∞–∂–Ω–æ –∑–∞–∫—Ä—ã–≤–∞—Ç—å —Å–µ—Å—Å–∏—é –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è!")
    db.close()
    print(f"   ‚úì –°–µ—Å—Å–∏—è –∑–∞–∫—Ä—ã—Ç–∞")

print("\n" + "=" * 70)
print("‚úì –î–ï–ú–û–ù–°–¢–†–ê–¶–ò–Ø –ó–ê–í–ï–†–®–ï–ù–ê")
print("=" * 70)

print("\n" + "üìö –†–ï–ó–Æ–ú–ï:")
print("   1. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ë–î ‚Üí app/core/config.py ‚Üí settings.DATABASE_URL")
print("   2. Engine —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ ‚Üí —Ö—Ä–∞–Ω–∏—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î")
print("   3. SessionLocal ‚Üí —Ñ–∞–±—Ä–∏–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π")
print("   4. init_db() ‚Üí —Å–æ–∑–¥–∞—ë—Ç —Ç–∞–±–ª–∏—Ü—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –º–æ–¥–µ–ª–µ–π")
print("   5. db = SessionLocal() ‚Üí —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Å—Å–∏—é –¥–ª—è —Ä–∞–±–æ—Ç—ã")
print("   6. db.close() ‚Üí –∑–∞–∫—Ä—ã–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é")













